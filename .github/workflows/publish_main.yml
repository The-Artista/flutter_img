name: publish

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  change_version:
    name: change_version
    runs-on: ubuntu-latest
    steps:
      - name: change version number
        run: |
          set -e

          # Find and increment the version number.
            perl -i -pe 's/^(version:\s+\d+\.\d+\.\d+\+)(\d+)$/$1.($2+1)/e' pubspec.yaml
          
          # Commit and tag this change.
          git add pubspec.yaml
          chmod +x .git/hooks/pre-commit

  publish:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{inputs.flutter_version}}
          channel: ${{inputs.flutter_channel}}
          cache: true

      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get

      - name: ğŸ” Setup Pub Credentials
        run: |
          mkdir -p $HOME/.config/dart
          cat <<EOF > $HOME/.config/dart/pub-credentials.json
          {
            "accessToken": "${{ secrets.PUB_CREDS_ACCESS_TOKEN }}",
            "refreshToken": "${{ secrets.PUB_CREDS_REFRESH_TOKEN }}",
            "idToken": "${{ secrets.PUB_CREDS_ID_TOKEN }}",
            "tokenEndpoint": "https://accounts.google.com/o/oauth2/token",
            "scopes": [ "openid", "https://www.googleapis.com/auth/userinfo.email" ],
            "expiration": ${{ secrets.PUB_CREDS_EXPIRATION }}
          }

      - name: ğŸ“¢ Publish
        run: flutter pub publish -f